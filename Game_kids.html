<script>
// --- ANTI STUCK SPLASH ---
function hideSplashScreen() {
    var splash = document.getElementById('splashScreen');
    if (splash && splash.style.display !== "none") {
        splash.style.opacity = '0';
        setTimeout(function(){ splash.style.display = 'none'; }, 700);
    }
}
setTimeout(hideSplashScreen, 2000);
document.addEventListener('DOMContentLoaded', function() {
    var splash = document.getElementById('splashScreen');
    if (splash) {
        splash.addEventListener('click', hideSplashScreen);
        splash.addEventListener('touchstart', hideSplashScreen);
    }
});
window.addEventListener('error', hideSplashScreen);

// --- AUDIO UNLOCK PER TOMBOL ---
function unlockAudio(audios) {
    audios.forEach(function(audio) {
        if (audio && audio.paused) {
            try {
                let p = audio.play();
                if (p && typeof p.then === "function") {
                    p.then(function() {
                        audio.pause();
                        audio.currentTime = 0;
                    }).catch(function(){});
                }
            } catch(e){}
        }
    });
}

// --- LOGIKA TOMBOL DAN MUSIK ---
document.addEventListener('DOMContentLoaded', function() {
    // --- Ambil audio satu2
    const audioIds = [
        'audio_opening','audio_bgm','audio_countdown','audio_pop','audio_button',
        'audio_benar','audio_salah','audio_gameover','audio_tangkaptarget','audio_targetbaru'
    ];
    const audios = audioIds.map(id => document.getElementById(id));
    // --- State
    let mode = null, level = null, musicOn = false, highScore = 0;
    // --- Tombol & elemen
    const modeBtn = document.getElementById('modeBtn');
    const levelBtn = document.getElementById('levelBtn');
    const startBtn = document.getElementById('startBtn');
    const ulangiBtn = document.getElementById('ulangiBtn');
    const menuBtn = document.getElementById('menuBtn');
    const backToMainBtn = document.getElementById('backToMainBtn');
    const backToMenuBtn = document.getElementById('backToMenu');
    const musicToggle = document.getElementById('musicToggle');
    const mainMenuScreen = document.getElementById('mainMenuScreen');
    const selectionScreen = document.getElementById('selectionScreen');
    const gameScreen = document.getElementById('gameScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const modeSelectionDisplay = document.getElementById('modeSelectionDisplay');
    const levelSelectionDisplay = document.getElementById('levelSelectionDisplay');
    const selectionTitle = document.getElementById('selectionTitle');
    const selectionOptions = document.getElementById('selectionOptions');
    const highScoreEl = document.getElementById('highScoreDisplay');
    const scoreEl = document.getElementById('score');
    const livesContainer = document.getElementById('livesContainer');
    const finalScoreEl = document.getElementById('finalScore');
    const finalCorrectEl = document.getElementById('finalCorrect');
    const dimOverlay = document.getElementById('dimOverlay');
    const bgm = document.getElementById('audio_bgm');

    // --- Helper universal unlock audio on tap/click
    function unlockAllAudios() { unlockAudio(audios); }

    // --- Event helper: pasang event click & touchstart
    function safeButton(btn, handler) {
        if (!btn) return;
        btn.addEventListener('click', function(e) { unlockAllAudios(); handler(e); });
        btn.addEventListener('touchstart', function(e) { unlockAllAudios(); handler(e); });
    }

    // --- Cek tombol mulai
    function checkAndEnableStartButton() {
        startBtn.disabled = !(mode && level);
    }

    // --- Pilihan Mode & Level (populasi dinamis)
    function showSelectionScreen(type) {
        mainMenuScreen.classList.remove('active');
        selectionScreen.classList.add('active');
        selectionTitle.textContent = `Pilih ${type}`;
        selectionOptions.innerHTML = '';
        let options;
        if (type === 'Mode') {
            options = [ { text: 'Huruf', value: 'letters' }, { text: 'Angka', value: 'numbers' }, { text: 'Hewan', value: 'animals' }, { text: 'Hijaiyah', value: 'hijaiyah' }, { text: 'Mix', value: 'mix' } ];
        } else {
            options = Array.from({ length: 10 }, (_, i) => ({ text: i + 1, value: i + 1 }));
        }
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt.text;
            safeButton(btn, function() {
                let sfx = document.getElementById('audio_button'); if(sfx) {try{sfx.currentTime=0;sfx.play();}catch(e){}}
                if (type === 'Mode') {
                    mode = opt.value;
                    modeSelectionDisplay.textContent = opt.text;
                    modeSelectionDisplay.classList.add('visible');
                    modeBtn.classList.remove('needs-selection');
                } else {
                    level = opt.value;
                    levelSelectionDisplay.textContent = `Level ${opt.text}`;
                    levelSelectionDisplay.classList.add('visible');
                    levelBtn.classList.remove('needs-selection');
                }
                selectionScreen.classList.remove('active');
                mainMenuScreen.classList.add('active');
                checkAndEnableStartButton();
            });
            selectionOptions.appendChild(btn);
        });
    }

    // --- Semua tombol utama
    safeButton(modeBtn, function() { showSelectionScreen('Mode'); });
    safeButton(levelBtn, function() { showSelectionScreen('Level'); });
    safeButton(backToMainBtn, function() {
        selectionScreen.classList.remove('active');
        mainMenuScreen.classList.add('active');
    });
    safeButton(startBtn, function() {
        if (startBtn.disabled) return;
        let sfx = document.getElementById('audio_button'); if(sfx) {try{sfx.currentTime=0;sfx.play();}catch(e){}}
        mainMenuScreen.classList.remove('active');
        gameScreen.classList.add('active');
        if(scoreEl) scoreEl.textContent = 0;
        if(livesContainer) livesContainer.innerHTML = '❤️❤️❤️❤️❤️';
        if(musicOn && bgm) { try{bgm.currentTime=0;bgm.play();}catch(e){alert('Gagal play musik');} }
    });
    safeButton(backToMenuBtn, function() {
        let sfx = document.getElementById('audio_button'); if(sfx) {try{sfx.currentTime=0;sfx.play();}catch(e){}}
        gameScreen.classList.remove('active');
        mainMenuScreen.classList.add('active');
        if(bgm) bgm.pause();
    });
    safeButton(ulangiBtn, function() {
        let sfx = document.getElementById('audio_button'); if(sfx) {try{sfx.currentTime=0;sfx.play();}catch(e){}}
        gameOverScreen.style.opacity = '0';
        setTimeout(function(){
            gameOverScreen.style.display = 'none';
            gameScreen.classList.add('active');
            if(scoreEl) scoreEl.textContent = 0;
            if(livesContainer) livesContainer.innerHTML = '❤️❤️❤️❤️❤️';
            if(musicOn && bgm){try{bgm.currentTime=0;bgm.play();}catch(e){alert('Gagal play musik');}}
        }, 500);
    });
    safeButton(menuBtn, function() {
        let sfx = document.getElementById('audio_button'); if(sfx) {try{sfx.currentTime=0;sfx.play();}catch(e){}}
        gameOverScreen.style.opacity = '0';
        setTimeout(function(){
            gameOverScreen.style.display = 'none';
            mainMenuScreen.classList.add('active');
            if(bgm) bgm.pause();
        }, 500);
    });
    safeButton(musicToggle, function() {
        musicToggle.classList.toggle("active");
        musicOn = musicToggle.classList.contains("active");
        if(musicOn && bgm) { try{bgm.currentTime=0;bgm.play();}catch(e){alert('Gagal play musik');} }
        else if(bgm) { bgm.pause(); }
    });

    // Skor tertinggi
    highScore = parseInt(localStorage.getItem('gameKidsHighScore') || '0', 10);
    highScoreEl.textContent = `Skor Tertinggi: ${highScore}`;
    mainMenuScreen.classList.add('active');
});
</script>
