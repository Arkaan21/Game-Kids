<script>
// --- Audio Context Unlock ---
function unlockAudioContext(audioManager) {
    if (audioManager.isUnlocked) return;
    audioManager.isUnlocked = true;
    try { audioManager.audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) {}
    const names = ['opening','bgm','countdown','pop','button','benar','salah','gameover','tangkaptarget','targetbaru'];
    names.forEach(name => { audioManager.sounds[name] = document.getElementById(`audio_${name}`); });
}
// Unlock audio on any user interaction (pointer/touch/keydown)
['pointerdown','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,()=>unlockAudioContext(audioManager),{once:true}));

// --- State & Data ---
let mode = null, level = null, target = 'A';
let score = 0, correctAnswers = 0, livesRemaining = 5, highScore = 0;
let running = false, objects = [], particles = [];
let animationFrameId;
const animals = ['🐶','🐯','🐻','🦁','🐵','🐼','🐰','🐸','🐷','🐮'];
const hijaiyah = ['ا','ب','ت','ث','ج','ح','خ','د','ذ','ر','ز','س','ش','ص','ض','ط','ظ','ع','غ','ف','ق','ك','ل','م','ن','ه','و','ي'];
const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
const numbers = '0123456789'.split('');
const allChars = [...letters, ...numbers, ...animals, ...hijaiyah];
const bubbleColors = ['#E74C3C', '#3498DB', '#2ECC71', '#9B59B6', '#F1C40F', '#E67E22', '#1ABC9C'];
const levelSettings = {1:{speed:0.8,spawn:1300},2:{speed:1.0,spawn:1150},3:{speed:1.3,spawn:1000},4:{speed:1.6,spawn:850},5:{speed:1.9,spawn:750},6:{speed:2.2,spawn:650},7:{speed:2.5,spawn:600},8:{speed:2.8,spawn:550},9:{speed:3.1,spawn:500},10:{speed:3.5,spawn:450}};

// --- DOM Elements ---
function safeGet(id){const el=document.getElementById(id);if(!el)alert('Elemen '+id+' tidak ditemukan!');return el;}
const splashScreen = safeGet('splashScreen');
const splashText = safeGet('splashText');
const mainMenuScreen = safeGet('mainMenuScreen');
const selectionScreen = safeGet('selectionScreen');
const gameScreen = safeGet('gameScreen');
const gameOverScreen = safeGet('gameOverScreen');
const modeBtn = safeGet('modeBtn');
const levelBtn = safeGet('levelBtn');
const startBtn = safeGet('startBtn');
const backToMainBtn = safeGet('backToMainBtn');
const backToMenuBtn = safeGet('backToMenu');
const ulangiBtn = safeGet('ulangiBtn');
const menuBtn = safeGet('menuBtn');
const dimOverlay = safeGet('dimOverlay');
const targetEl = safeGet('target');
const scoreEl = safeGet('score');
const livesContainer = safeGet('livesContainer');
const highScoreEl = safeGet('highScoreDisplay');
const finalScoreEl = safeGet('finalScore');
const finalCorrectEl = safeGet('finalCorrect');
const canvas = safeGet('gameCanvas'), ctx = canvas.getContext('2d');
const popCanvas = safeGet('popCanvas'), pctx = popCanvas.getContext('2d');
const modeSelectionDisplay = safeGet('modeSelectionDisplay');
const levelSelectionDisplay = safeGet('levelSelectionDisplay');
const selectionTitle = safeGet('selectionTitle');
const selectionOptions = safeGet('selectionOptions');
const musicToggle = safeGet('musicToggle');

// --- Audio Manager (sama seperti sebelumnya, tidak diubah) ---
// ...
// --- Kode lainnya tetap sama kecuali perubahan di atas ---
</script>